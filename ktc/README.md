# KTC (Kona Traffic Controller) ğŸ˜

## Requirement

- `1ë¶„` ë‹¨ìœ„ ìµœëŒ€ í—ˆìš©ì¹˜`(Threshold)`ë§Œí¼ íŠ¸ë˜í”½ ì œí•œí•˜ì—¬ ëŒ€ìš©ëŸ‰ íŠ¸ë˜í”½ ì œì–´
    - `1ë¶„` ì„ `6ì´ˆ` ë‹¨ìœ„ë¡œ `ceil(threshold/10)` ë§Œí¼ íŠ¸ë˜í”½ ì§„ì…í•˜ë„ë¡ ì œì–´ ì²˜ë¦¬
    - íŠ¸ë˜í”½ ëŒ€ê¸° ìš”ì²­ ì˜ˆìƒ ê±´ìˆ˜ : `70K` ~ `100K`
- íŠ¸ë˜í”½ ëŒ€ê¸° ìš”ì²­ ìˆœì„œë¥¼ ë³´ì¥í•˜ë©°, ëŒ€ê¸° ì˜ˆìƒ ì‹œê°„ ê³„ì‚° & ì „ì²´ ëŒ€ê¸°ì ìˆ˜ ì‘ë‹µ ì²˜ë¦¬

---

## Architecture

### íŠ¸ë˜í”½ ì œì–´ ì²˜ë¦¬ í”„ë¡œì„¸ìŠ¤

- 1ë¶„ë‹¹ ì§„ì… í—ˆìš© ì„ê³„ì¹˜(`threshold`) ì„¤ì • ê¸°ë°˜ íŠ¸ë˜í”½ ì œì–´ ì²˜ë¦¬
  - 1ë¶„ íŠ¸ë˜í”½ì€ 6ì´ˆë§ˆë‹¤ `ceil(threshold/10)` ë§Œí¼ íŠ¸ë˜í”½ ì§„ì… ì²˜ë¦¬
- íŠ¸ë˜í”½ ì§„ì… ëŒ€ê¸° ì²˜ë¦¬ ì‹œ, ëŒ€ê¸° ìˆœë²ˆ í• ë‹¹ & ëŒ€ê¸° ì˜ˆìƒ ì‹œê°„ ê³„ì‚°
- íŠ¸ë˜í”½ ëŒ€ê¸° ìˆœë²ˆì€ ê³ ìœ í•œ `token` ì‹ë³„ì ì§„ì… ì‹œì  ê¸°ì¤€ìœ¼ë¡œ ëŒ€ê¸° ìˆœë²ˆ í• ë‹¹
- íŠ¸ë˜í”½ ëŒ€ê¸° ìƒíƒœ `token` ì€ **ë°˜ë³µ ìš”ì²­(ì§„ì… í™•ì¸)** ì„ í†µí•´ íŠ¸ë˜í”½ ì§„ì… í—ˆìš© í™•ì¸

> #### ì˜ˆìƒ ì‹œë‚˜ë¦¬ì˜¤
> 
> 1. ë¶„ë‹¹ `threshold`: 2000 (6ì´ˆë‹¹ 200 í—ˆìš©)
>    - 1 ~ 2000ë²ˆ: ì¦‰ì‹œ ì…ì¥ ê°€ëŠ¥ (0ë¶„ ëŒ€ê¸°)
>    - 2001 ~ 4000ë²ˆ: 1ë¶„ ëŒ€ê¸° í›„ ì…ì¥
>    - 4001 ~ 6000ë²ˆ: 2ë¶„ ëŒ€ê¸° í›„ ì…ì¥
> 2. `threshold` ë³€ê²½: 2000 > 1000 ê°ì†Œ (6ì´ˆë‹¹ 100 í—ˆìš©)
>    - 6001 ~ 7000ë²ˆ: 3ë¶„ ëŒ€ê¸° í›„ ì…ì¥
>    - 7001 ~ 8000ë²ˆ: 4ë¶„ ëŒ€ê¸° í›„ ì…ì¥
>    - 8001 ~ 9000ë²ˆ: 5ë¶„ ëŒ€ê¸° í›„ ì…ì¥
>    - 9001 ~ 10000ë²ˆ: 6ë¶„ ëŒ€ê¸° í›„ ì…ì¥
> 3. `threshold` ë³€ê²½ : 1000 > 500 ê°ì†Œ (6ì´ˆë‹¹ 50 í—ˆìš©)
>    - 10001 ~ 10500ë²ˆ: 7ë¶„ ëŒ€ê¸° í›„ ì…ì¥
>    - 10501 ~ 11000ë²ˆ: 8ë¶„ ëŒ€ê¸° í›„ ì…ì¥
> 4. `threshold` ë³€ê²½ : 500 > 1000 ì¦ê°€ (6ì´ˆë‹¹ 100 í—ˆìš©)
>    - 11001 ~ 12000ë²ˆ: 9ë¶„ ëŒ€ê¸° í›„ ì…ì¥

---

## Implementation

### ë„¤íŠ¸ì›Œí¬ í†µì‹ 

- **HTTP Long-Term Polling (ì„ ì •)** : ì¼ì • ì£¼ê¸° `Client > Server` HTTP ìš”ì²­í•˜ì—¬ ë°˜ë³µ ë©”ì‹œì§€ ì „ì†¡ ë°©ì‹
- HTTP SSEs : `Client < Server` ë‹¨ë°©í–¥ ë©”ì‹œì§€ ì „ì†¡ ê°€ëŠ¥í•œ HTTP Streaming ë°©ì‹ 
- WebSocket : `Client <> Server` ì–‘ë°©í–¥ ë©”ì‹œì§€ ì „ì†¡ ê°€ëŠ¥í•œ TCP Socket ë°©ì‹

> **HTTP Long-Term Polling ì„ ì • ì´ìœ **
> 
> - ìš”êµ¬ ì‚¬í•­ì„ ì¶©ì¡±í•˜ë©°, **ê¸´ ì£¼ê¸° Polling ë°©ì‹ì€ ì„œë²„ ë¶€í•˜ë¥¼ ë°©ì§€í•  ìˆ˜ ìˆëŠ” ë°©ë²•** ì¤‘ í•˜ë‚˜ë¡œ íŒë‹¨í•˜ì—¬ ì„ ì •
> - íŠ¸ë˜í”½ ëŒ€ê¸° ì‹œ, ëŒ€ê¸° ìˆœë²ˆ ê¸°ì¤€ Client > Server Polling ì£¼ê¸° ì¡°ì ˆí•˜ì—¬ ë¶€í•˜ ë¶„ì‚°
>   - ëŒ€ê¸° ìˆœë²ˆ `0 ~ 20_000`       : `3000ms` Polling ìš”ì²­
>   - ëŒ€ê¸° ìˆœë²ˆ `20_000 ~ 150_000` : `6000ms` Polling ìš”ì²­
>   - ëŒ€ê¸° ìˆœë²ˆ `150_000 ~`        : `9000ms` Polling ìš”ì²­

### íŠ¸ë˜í”½ ì œì–´ ì²˜ë¦¬

#### íŠ¸ë˜í”½ ëŒ€ê¸° ìˆœì„œ ê´€ë¦¬: Redis í™œìš©

- Redis `Sorted-Set` ìë£Œêµ¬ì¡° í™œìš©í•˜ì—¬ íŠ¸ë˜í”½ ë°€ë¦¬ì´ˆ ë‹¨ìœ„ ëŒ€ê¸° ìš”ì²­ ì‹œê°„(`score`) ê¸°ì¤€ ëŒ€ê¸° ìˆœì„œ ì •ë ¬
- íŠ¸ë˜í”½ ëŒ€ê¸° ìˆœì„œ ë³´ì¥ & ë™ì‹œì„± ë³´ì¥ì„ ìœ„í•´ `Lua Script` í™œìš©í•œ Redis ì—°ì‚° ì²˜ë¦¬
- Redis Cluster í™˜ê²½ì—ì„œ **í•´ì‹œ íƒœê·¸(`{}`)** ì‚¬ìš©í•˜ì—¬ í•˜ë‚˜ì˜ Redis ë…¸ë“œì— ìºì‹œ ë°ì´í„° ë°°ì¹˜í•˜ë„ë¡ ìºì‹œ Key êµ¬ì„±

> **`Lua Script` ë„ì… ì‚¬ìœ **
> 
> - íŠ¸ë˜í”½ ì œì–´ë¥¼ ìœ„í•´ì„œëŠ” **ì—¬ëŸ¬ ê°œì˜ Redis ëª…ë ¹ì–´ í˜¸ì¶œ ë° ì—°ì‚° í•„ìš”**
> - Redis ì— `Lua Script` ì‹¤í–‰ ìš”ì²­ì‹œ, ìŠ¤í¬ë¦½íŠ¸ ë‚´ë¶€ **ì—¬ëŸ¬ ê°œì˜ ëª…ë ¹ì–´ë¥¼ í•˜ë‚˜ì˜ íŠ¸ëœì­ì…˜ìœ¼ë¡œ ì‹¤í–‰í•˜ê¸° ë•Œë¬¸ì—** ì›ìì„± ë³´ì¥
>   - **Redis Cluster í™˜ê²½ì—ì„œë„** ì›ìì„± ë³´ì¥ ê°€ëŠ¥
>   - ë™ì‹œ ì—¬ëŸ¬ ê°œì˜ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ëª…ë ¹ì—ë„ **Redis `Single-Thread` ê¸°ë°˜ìœ¼ë¡œ ë™ì‘í•˜ê¸° ë•Œë¬¸ì—** ì›ìì„± ë³´ì¥ ê°€ëŠ¥

#### íŠ¸ë˜í”½ ëŒ€ê¸°/ì§„ì… ì œì–´: `Sliding-Window` ì•Œê³ ë¦¬ì¦˜

- `window` & `slot` ë³„ë¡œ ê°ê° `threshold` ë§Œí¼ íŠ¸ë˜í”½ ì§„ì… í—ˆìš© í›„ ë‚˜ë¨¸ì§€ ìš”ì²­ì€ ëŒ€ê¸° ì²˜ë¦¬
  - `window` : `1ë¶„` íŠ¸ë˜í”½ ì§„ì… í—ˆìš© ë‹¨ìœ„
  - `slot` : `6ì´ˆ` íŠ¸ë˜í”½ ì§„ì… í—ˆìš© ë‹¨ìœ„
  - 1ë¶„ë™ì•ˆ íŠ¸ë˜í”½ ì§„ì… ìš”ì²­ì— ëŒ€í•´ `{zoneId}:window-entry-count:<í˜„ì¬ ì‹œê°„(ë¶„)>` ìºì‹œ `threshold` ë§Œí¼ ì¦ê°€ ì²˜ë¦¬
  - 6ì´ˆë™ì•ˆ íŠ¸ë˜í”½ ì§„ì… ìš”ì²­ì— ëŒ€í•´ `{zoneId}:slot-entry-count:<í˜„ì¬ ì‹œê°„(ë¶„)>:<í˜„ì¬ slot>` ìºì‹œ `threshold / 10` ë§Œí¼ ì¦ê°€ ì²˜ë¦¬
    - `<í˜„ì¬ ì‹œê°„(ë¶„)>`: í˜„ì¬ ì‹œê°„ ê¸°ì¤€ ë¶„ ì¶”ì¶œ
      - ê³„ì‚° ì‹ : `nowMillis / 60000`
      - ex) í˜„ì¬ ì‹œê°„ : `2025/06/18 13:09:30` > `09` ë¶„ë§Œ ì¶”ì¶œ 
    - `<í˜„ì¬ slot>` : í˜„ì¬ ì‹œê°„(ì´ˆ) ê¸°ì¤€ slot ê³„ì‚°
      - ê³„ì‚° ì‹ : `(nowMillis % 60000) / 6000 / 6`
      - ex) í˜„ì¬ ì‹œê°„ : `2025/06/18 13:09:30` > `30` ì´ˆ ì¶”ì¶œ > `30 / 6 = 5` slot ê³„ì‚°

![íŠ¸ë˜í”½ ì œì–´ ì²˜ë¦¬ íƒ€ì„ë¼ì¸](../docs/images/ktc-image-01.png)

#### íŠ¸ë˜í”½ ì œì–´ ì²˜ë¦¬ ìˆœì„œ

1. íŠ¸ë˜í”½ Zone ì„ê³„ê°’(`threshold`) ì¡°íšŒ
   - `threshold` ì •ë³´ ì—†ëŠ” ê²½ìš°, `defaultThreshold` í™œìš©
2. window & slot ê³„ì‚°
3. window & slot ìºì‹œ ì¡°íšŒ
4. ëŒ€ê¸°ì—´ Queue(`Sorted-Set`) íŠ¸ë˜í”½ ì§„ì… ìš”ì²­ `token` ì €ì¥
5. ì§„ì… í—ˆìš© ì¡°ê±´ íŒë‹¨ ë° ì²˜ë¦¬
   - ì§„ì… í—ˆìš© ì¡°ê±´
     - `widowEntryCount < threshold`
     - `slotEntryCount < allowedPer6Sec and (rank < allowedPer6Sec or waitingTime <= nowMilli)`
        - `allowedPer6Sec = ceil(threshold / 10)`
   - ì§„ì… í—ˆìš© ì²˜ë¦¬
     - `windowEntryCount` ì¦ê°€
     - `slotEntryCount` ì¦ê°€
     - Zone ì „ì²´ `entryCount` ì¦ê°€
     - ëŒ€ê¸°ì—´ Queue íŠ¸ë˜í”½ ì§„ì… ìš”ì²­ `token` ì œê±°
     - `token` ë§ˆì§€ë§‰ Polling ìš”ì²­ ì‹œê°„ Cache ì‚­ì œ
   - ì§„ì… ëŒ€ê¸° ì²˜ë¦¬
     - `token` ë§ˆì§€ë§‰ Polling ìš”ì²­ ì‹œê°„ Cache ì €ì¥(`Sorted-Set`)
     - ëŒ€ê¸° ì˜ˆìƒ ì‹œê°„ ê³„ì‚°
     - ëŒ€ê¸°ì—´ Queue `totalCount` ì¡°íšŒ

> **ëŒ€ê¸° ì˜ˆìƒ ì‹œê°„ ê³„ì‚°ì‹** : `estimatedTime - totalWaitingTime`
> 
>  - `estimatedTime = rank / allowedPer6Sec * 6000`
>  - `totalWaitingTime = tokenLastPollingTime(or nowMilli) - entryMilli(score)`

---

### Project Specification

- JDK 21
- Kotlin 1.9.25
- Spring Boot 3.4.4
- Spring Data Redis Reactive (+ Lettuce)
- Redis (Amazon ElasticCache)

### Project Package Structure

```
src/main/kotlin/com/kona/ktc/
â”œâ”€â”€ application/
â”‚   â””â”€â”€ usecase/ 
â”œâ”€â”€ domain/
â”‚   â”œâ”€â”€ event/
â”‚   â”œâ”€â”€ model/
â”‚   â””â”€â”€ port/
â”‚       â”œâ”€â”€ input/
â”‚       â””â”€â”€ output/
â”œâ”€â”€ infrastructure/
â”‚   â”œâ”€â”€ adapter/
â”‚   â”‚   â””â”€â”€ redis/
â”‚   â”œâ”€â”€ config/
â”‚   â””â”€â”€ error/
â””â”€â”€ presentation/
    â”œâ”€â”€ adapter/
    â””â”€â”€ dto/
        â”œâ”€â”€ mapper/
        â”œâ”€â”€ request/
        â””â”€â”€ response/
```

---
