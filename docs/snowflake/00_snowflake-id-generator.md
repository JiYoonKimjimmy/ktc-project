# Snowflake ID Generator

## 1. Snowflake ID?

- `Snowflake ID` 는 `Twitter` 사에서 개발한 **분산 시스템용 고유 ID 생성 알고리즘**
- `64bits` 정수를 사용하여 `타임스탬프`, `워커 ID`, `시퀀스 번호`를 포함하여 고유한 ID 생성
- 실제 사용 비트는 58bits (Timestamp 41bits + Worker ID 5bits + Sequence 12bits)
- 나머지 6bits는 미래 확장을 위해 예약됨

### 주요 특징

- **분산 환경 지원**: 여러 서버에서 동시에 ID를 생성해도 중복되지 않음
- **시간 기반 정렬**: 타임스탬프가 포함되어 시간 순서대로 정렬 가능
- **고성능**: 메모리에서 처리되며 외부 의존성이 없음
- **확장성**: 워커 ID를 통해 여러 서버 지원

---

## 2. Snowflake ID 구조

### 64bits 구조 (실제 사용 58bits)

```
+----------------+----------------+----------------+----------------+
|   Timestamp    |   Worker ID    |   Sequence     |   Reserved     |
+----------------+----------------+----------------+----------------+
|     41 bits    |     5 bits     |    12 bits     |     6 bits     |
+----------------+----------------+----------------+----------------+
|<------------------------- 64 bits ------------------------------>|
```

### 2.1 각 필드 설명

#### Timestamp (41 bits)

- Unix epoch(1970-01-01)부터 현재까지의 밀리초
- 2^41 밀리초 = 약 69년간 사용 가능
- 1970년 기준으로 2039년까지 사용 가능

#### Worker ID (5 bits)

- 서버나 인스턴스를 구분하는 ID
- 2^5 = 32개의 워커(서버) 지원 가능
- 일반적으로 서버의 IP나 호스트명을 기반으로 생성

#### Sequence (12 bits)

- 같은 밀리초 내에서 순차적으로 증가하는 값
- 2^12 = 4,096개의 시퀀스 번호
- 같은 밀리초 내에 최대 4,096개의 ID 생성 가능

---

## 3. 생성 가능한 ID 수

- 이론적 최대 생성 가능 개수:
  - 초당: 4,096개 × 1,000밀리초 = 4,096,000개
  - 분당: 4,096,000개 × 60초 = 245,760,000개
  - 시간당: 245,760,000개 × 60분 = 14,745,600,000개
  - 일당: 14,745,600,000개 × 24시간 = 353,894,400,000개

---

## 4. SnowflakeIdGenerator 구현

### SnowflakeID 생성

#### Worker ID 초기화

- 서버 IP의 마지막 옥텟을 사용하여 워커 ID 생성

```kotlin
workerId = InetAddress.getLocalHost().hostAddress.split(".")[3].toLong() % (MAX_WORKER_ID + 1)
```

#### ID 생성 로직

1. 현재 타임스탬프 확인
2. 시계 역행 검사
3. 시퀀스 번호 증가 
4. 비트 연산을 통한 ID 조합

#### 시계 역행 처리
 
- 시스템 시계가 역행할 경우 예외 발생

```kotlin
if (timestamp < lastTimestamp) {
    throw RuntimeException("Clock moved backwards")
}
```

### 성능 특성

|    구분    | 설명                                 |
|:--------:|------------------------------------|
|  단일 스레드  | 초당 100,000개 이상의 ID 생성 가능           |
|  멀티스레드   | 4개 스레드 기준 초당 200,000개 이상의 ID 생성 가능 |
| 평균 처리 시간 | 약 2,000-8,000 나노초/ID               |

---

## 5. 사용 시 주의사항

1. **시계 동기화**
   - NTP 등을 통한 시계 동기화 필요
   - 시계 드리프트 허용 범위 설정

2. **워커 ID 관리**
   - 워커 ID 중복 방지 필요
   - 동적 워커 ID 할당 시스템 구현 가능

3. **시스템 시계 역행**
   - 시스템 시계가 역행할 경우 ID 중복 가능성
   - 시계 역행 감지 및 처리 로직 필요

4. **ID 길이**
   - 64비트 정수를 문자열로 변환 시 최대 19자리
   - 필요시 19자리로 패딩하여 고정 길이 사용 가능

---

#### Reference

- Twitter 원본 구현: https://github.com/twitter-archive/snowflake
- 128비트 확장 버전도 존재 (더 긴 타임스탬프, 더 많은 워커 ID 지원)
- 분산 환경에서의 고유성 보장을 위해 널리 사용됨

---
